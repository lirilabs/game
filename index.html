<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>XO Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Ably -->
<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

<style>
  body {
    margin: 0;
    font-family: Roboto, system-ui, sans-serif;
    background: #f5f5f5;
  }

  .container {
    max-width: 420px;
    margin: 40px auto;
    padding: 24px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  }

  h1 {
    font-size: 32px;
    margin-bottom: 8px;
    text-align: left;
  }

  .status {
    font-size: 20px;
    margin: 16px 0;
    color: #333;
  }

  .board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .cell {
    height: 100px;
    font-size: 48px;
    background: #fafafa;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    box-shadow: inset 0 0 0 2px #e0e0e0;
  }
</style>
</head>
<body>

<div class="container">
  <h1>XO Online</h1>
  <div class="status" id="status">Connecting…</div>
  <div class="board" id="board"></div>
</div>

<script>
/* ================= CONFIG (TESTING ONLY) ================= */
const ABLY_API_KEY = "YOUR_ABLY_API_KEY_HERE";
/* ======================================================== */

const ably = new Ably.Realtime({ key: ABLY_API_KEY });
const channel = ably.channels.get("xo-global");

const playerId = Math.random().toString(36).slice(2);
let mySymbol = null;
let myTurn = false;

let board = Array(9).fill("");

const winPatterns = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");

/* ---------- UI SETUP ---------- */
for (let i = 0; i < 9; i++) {
  const cell = document.createElement("div");
  cell.className = "cell";
  cell.onclick = () => makeMove(i);
  boardEl.appendChild(cell);
}

/* ---------- PRESENCE (AUTO MATCH) ---------- */
channel.presence.enter({ id: playerId });

channel.presence.subscribe(() => assignRoles());

function assignRoles() {
  channel.presence.get((err, members) => {
    if (err) return;

    if (members.length >= 1 && members[0].clientId === playerId) {
      mySymbol = "X";
      myTurn = true;
    } else if (members.length >= 2 && members[1].clientId === playerId) {
      mySymbol = "O";
      myTurn = false;
    } else {
      mySymbol = "Spectator";
      myTurn = false;
    }

    updateStatus();
  });
}

/* ---------- GAME SYNC ---------- */
channel.subscribe("move", msg => {
  board = msg.data.board;
  myTurn = msg.data.turn === mySymbol;
  render();
  checkWinner();
});

function makeMove(index) {
  if (!myTurn || !board[index] || mySymbol === "Spectator") return;

  board[index] = mySymbol;
  myTurn = false;

  channel.publish("move", {
    board,
    turn: mySymbol === "X" ? "O" : "X"
  });

  render();
  checkWinner();
}

/* ---------- RENDER ---------- */
function render() {
  [...boardEl.children].forEach((cell, i) => {
    cell.innerText = board[i];
  });

  updateStatus();
}

function updateStatus() {
  if (mySymbol === "Spectator") {
    statusEl.innerText = "Spectating game";
  } else {
    statusEl.innerText = myTurn
      ? "Your turn (" + mySymbol + ")"
      : "Waiting for opponent…";
  }
}

/* ---------- WIN CHECK ---------- */
function checkWinner() {
  for (const p of winPatterns) {
    const [a,b,c] = p;
    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
      statusEl.innerText = board[a] + " wins!";
      myTurn = false;
      return;
    }
  }

  if (!board.includes("")) {
    statusEl.innerText = "Draw!";
  }
}
</script>

</body>
</html>
