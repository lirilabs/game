<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>3D Multiplayer Survival</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body { margin:0; overflow:hidden; background:#000; }
#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 10;
  color: #fff;
  font-family: system-ui;
}
input, button {
  padding: 6px;
  margin-right: 4px;
}
</style>

<!-- Ably -->
<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
<!-- Three.js -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
</head>
<body>

<div id="ui">
  <input id="room" placeholder="Room ID" />
  <button onclick="joinRoom()">Join Room</button>
</div>

<script>
/* ================= CONFIG (TESTING ONLY) ================= */
const ABLY_API_KEY = "YOUR_ABLY_KEY_HERE";
/* ========================================================= */

let ably, channel, roomId;
const playerId = Math.random().toString(36).slice(2);
const players = {};
const speed = 0.15;

/* ---------------- THREE.JS SETUP ---------------- */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0b0b0b);

const camera = new THREE.PerspectiveCamera(
  60, innerWidth / innerHeight, 0.1, 1000
);
camera.position.set(0, 8, 8);
camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

/* LIGHT */
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const light = new THREE.DirectionalLight(0xffffff, 0.6);
light.position.set(5, 10, 5);
scene.add(light);

/* FLOOR */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(50, 50),
  new THREE.MeshStandardMaterial({ color:0x222222 })
);
floor.rotation.x = -Math.PI / 2;
scene.add(floor);

/* ---------------- PLAYER CREATION ---------------- */
function createPlayer(id, isMe=false) {
  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(0.4, 16, 16),
    new THREE.MeshStandardMaterial({
      color: isMe ? 0x4caf50 : 0x2196f3
    })
  );
  scene.add(mesh);
  players[id] = { mesh, x:0, z:0 };
}

/* ---------------- CONTROLS ---------------- */
const keys = {};
onkeydown = e => keys[e.key] = true;
onkeyup = e => keys[e.key] = false;

/* ---------------- JOIN ROOM ---------------- */
function joinRoom() {
  roomId = document.getElementById("room").value.trim();
  if (!roomId) return alert("Enter room id");

  document.getElementById("ui").style.display = "none";

  ably = new Ably.Realtime({
    key: ABLY_API_KEY,
    clientId: playerId
  });

  channel = ably.channels.get("room-" + roomId);

  createPlayer(playerId, true);

  /* SEND STATE */
  setInterval(() => {
    const me = players[playerId];
    channel.publish("state", {
      id: playerId,
      x: me.x,
      z: me.z
    });
  }, 50);

  /* RECEIVE STATE */
  channel.subscribe("state", msg => {
    const { id, x, z } = msg.data;
    if (!players[id]) createPlayer(id);
    players[id].x = x;
    players[id].z = z;
  });

  animate();
}

/* ---------------- GAME LOOP ---------------- */
function update() {
  const me = players[playerId];
  if (!me) return;

  if (keys.w) me.z -= speed;
  if (keys.s) me.z += speed;
  if (keys.a) me.x -= speed;
  if (keys.d) me.x += speed;

  for (const id in players) {
    const p = players[id];
    p.mesh.position.set(p.x, 0.4, p.z);
  }

  camera.position.x = me.x;
  camera.position.z = me.z + 8;
  camera.lookAt(me.x, 0, me.z);
}

function animate() {
  requestAnimationFrame(animate);
  update();
  renderer.render(scene, camera);
}
</script>

</body>
</html>
